const { jidDecode } = require('@whiskeysockets/baileys');

const decode = jid => (jidDecode(jid)?.user || jid.split('@')[0]) + '@s.whatsapp.net';

module.exports = {
    command: 'ØªÙ‡ÙƒÙŠØ±',
    description: 'ØªÙ‡ÙƒÙŠØ± ÙˆÙ‡Ù…ÙŠ Ù„Ø¹Ø¶Ùˆ Ù…Ø­Ø¯Ø¯ (Ù…Ø²Ø­Ø©)',
    usage: '.ØªÙ‡ÙƒÙŠØ± @Ø¹Ø¶Ùˆ Ø£Ùˆ Ø¨Ø§Ù„Ø±Ø¯ Ø£Ùˆ ÙÙŠ Ø§Ù„Ø®Ø§Øµ',
    category: 'fun',

    async execute(sock, msg) {
        try {
            const groupJid = msg.key.remoteJid;
            const isGroup = groupJid.endsWith('@g.us');
            const mentioned = msg.message?.extendedTextMessage?.contextInfo?.mentionedJid?.[0];
            const quoted = msg.message?.extendedTextMessage?.contextInfo?.participant;
            const isPrivate = !isGroup;

            const targetJid = mentioned || quoted || (isPrivate ? msg.key.remoteJid : null);

            if (!targetJid) {
                return await sock.sendMessage(groupJid, {
                    text: 'â— Ù…Ù†Ø´Ù† Ø´Ø®Øµ Ø£Ùˆ Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.'
                }, { quoted: msg });
            }

            const targetID = decode(targetJid).split('@')[0];

            const steps = [
                "ğŸ“· Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø®Ø§ØµØ©...",
                "ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©...",
                "ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†...",
                "ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ...",
                "ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±...",
                "ğŸ’¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ ÙˆØ§ØªØ³Ø§Ø¨...",
                "ğŸ›¡ï¸ Ø³Ø±Ù‚Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...",
                "ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø³ÙŠØ±ÙØ± Ø³ÙˆÙ†Øº..."
            ];

            const progressBars = [
                "â–°â–±â–±â–±â–±â–±â–±â–±â–±â–± 10%",
                "â–°â–°â–±â–±â–±â–±â–±â–±â–±â–± 20%",
                "â–°â–°â–°â–±â–±â–±â–±â–±â–±â–± 30%",
                "â–°â–°â–°â–°â–±â–±â–±â–±â–±â–± 40%",
                "â–°â–°â–°â–°â–°â–±â–±â–±â–±â–± 50%",
                "â–°â–°â–°â–°â–°â–°â–±â–±â–±â–± 60%",
                "â–°â–°â–°â–°â–°â–°â–°â–±â–±â–± 70%",
                "â–°â–°â–°â–°â–°â–°â–°â–°â–±â–± 80%",
                "â–°â–°â–°â–°â–°â–°â–°â–°â–°â–± 90%",
                "â–°â–°â–°â–°â–°â–°â–°â–°â–°â–° 100%"
            ];

            // Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø©
            let sent = await sock.sendMessage(groupJid, {
                text: `ğŸ§  Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ±Ø§Ù‚ ${targetID}...\n${steps[0]}\n${progressBars[0]}`
            }, { quoted: msg });

            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§
            for (let i = 1; i < steps.length; i++) {
                await new Promise(res => setTimeout(res, 1200));
                await sock.sendMessage(groupJid, {
                    edit: sent.key,
                    text: `ğŸ§  Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ±Ø§Ù‚ ${targetID}...\n${steps[i]}\n${progressBars[i]}`
                });
            }

            // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©
            await new Promise(res => setTimeout(res, 1500));
            await sock.sendMessage(groupJid, {
                edit: sent.key,
                text: `âœ… ØªÙ… Ø§Ø®ØªØ±Ø§Ù‚ ${targetID} Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‘‘ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¹Ù†Ø¯ ÙƒÙŠÙ†Ø¬.\nğŸ“¨ Ø±ÙˆØ­ Ø®Ø¯Ù‡Ø§ Ù‚Ø¨Ù„ Ù…Ø§ Ù†ÙØ¶Ø­Ùƒ ğŸ˜ˆ\n${progressBars[9]}`
            });

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø£Ù…Ø± ØªÙ‡ÙƒÙŠØ±:', error);
            await sock.sendMessage(msg.key.remoteJid, {
                text: `âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°:\n\n${error.message || error.toString()}`,
            }, { quoted: msg });
        }
    }
};