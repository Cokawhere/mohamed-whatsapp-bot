const welcomedParticipants = new Set();
let welcomeActive = false;

module.exports = {
  command: 'ØªØ±Ø­ÙŠØ¨',
  description: 'ÙŠØ±Ø­Ø¨ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯ Ø¹Ù†Ø¯ Ø§Ù†Ø¶Ù…Ø§Ù…Ù‡Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.',
  category: 'group',

  async execute(sock, msg) {
    const groupId = msg.key.remoteJid;

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…ÙØ¹Ù„ØŒ Ù†ÙØ¹Ù„Ù‡ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙ†ÙÙŠØ° Ù„Ù„Ø£Ù…Ø± ÙˆÙ†Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ÙŠØ©
    if (!welcomeActive) {
      welcomeActive = true;
      await sock.sendMessage(groupId, {
        text: 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯.\n- Ø§ÙƒØªØ¨ "Ù‚ÙÙ„ Ø§Ù„ØªØ±Ø­ÙŠØ¨" Ù„ØªØ¹Ø·ÙŠÙ„Ù‡.'
      });

      // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
      sock.ev.on('group-participants.update', async (update) => {
        if (!welcomeActive) return;
        if (update.id !== groupId) return;
        if (update.action !== 'add') return;

        const groupMetadata = await sock.groupMetadata(groupId);
        const groupName = groupMetadata.subject;

        for (const participant of update.participants) {
          if (welcomedParticipants.has(participant)) continue;

          let ppUrl = await sock.profilePictureUrl(participant, 'image').catch(() => null);
          if (!ppUrl) {
            // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©ØŒ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            ppUrl = await sock.profilePictureUrl(groupId, 'image').catch(() => null);
          }

          const welcomeMessage = `
*â› â”â”â”â”â”â”ï½¥âª â â« ï½¥â”â”â”â”â”â” âœ*
â’ *â•­â”ˆâŠ°* ğŸŒ·Ø§Ù„Ù€Ù€ØªÙ€Ù€Ø±Ø­Ù€Ù€ÙŠÙ€Ù€Ø¨ğŸŒ· *âŠ°â”ˆ âœ¦*
*â”ŠË¹ğŸ“¯Ë¼â”Š Ø§Ù‡Ù€Ù€Ù„Ø§ Ø¨Ù€Ùƒ/ÙŠ*
â”ŠË¹ğŸ¥·ğŸ»Ë¼â”Š @${participant.split('@')[0]}
â”ŠğŸ“© *Ø§Ù‚Ø±Ø£ ÙˆØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©*

> *Ù…Ù†ÙˆØ± Ø§Ù„Ø¬Ø±ÙˆØ¨ â”ŠË¹âœ…Ë¼â”Š*
*â› â”â”â”â”â”â”ï½¥âª â â« ï½¥â”â”â”â”â”â” âœ*
> ğ‘©ğ›©ğ‘» - ğ‘²ğ‘°ğ‘µğ‘® ğŸŒ‘
`;

          const media = ppUrl
            ? { image: { url: ppUrl }, caption: welcomeMessage }
            : { text: welcomeMessage };

          await sock.sendMessage(groupId, {
            ...media,
            mentions: [participant]
          });

          welcomedParticipants.add(participant);
          setTimeout(() => welcomedParticipants.delete(participant), 60000);
        }
      });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£ÙˆØ§Ù…Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ±Ø­ÙŠØ¨
    const text = msg.message.conversation || msg.message.extendedTextMessage?.text;
    if (text && text.toLowerCase() === 'Ù‚ÙÙ„ Ø§Ù„ØªØ±Ø­ÙŠØ¨') {
      welcomeActive = false;
      welcomedParticipants.clear();
      await sock.sendMessage(groupId, { text: 'â›” ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯.' });
    }
  }
};